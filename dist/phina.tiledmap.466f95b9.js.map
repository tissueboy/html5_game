{"version":3,"sources":["phina.tiledmap.js","node_modules/parcel/src/builtins/hmr-runtime.js"],"names":["phina","define","superClass","image","tilesets","layers","init","superInit","_load","resolve","path","last","src","lastIndexOf","substring","_resolve","self","xml","XMLHttpRequest","open","onreadystatechange","readyState","indexOf","status","data","responseText","DOMParser","parseFromString","dataType","_parse","send","getMapData","layerName","i","length","name","concat","getObjectGroup","groupName","ls","len","type","obj","_cloneObjectLayer","push","getImage","numLayer","generated","width","tilewidth","height","tileheight","canvas","graphics","Canvas","setSize","args","find","visible","layer","mapdata","opacity","count","y","x","index","_setMapChip","objects","forEach","e","gid","bind","asset","AssetManager","get","source","context","drawImage","domElement","texture","Texture","srcLayer","result","$safe","resObj","properties","$extend","ellipse","polygon","clone","polyline","map","getElementsByTagName","console","log","attr","_attrToJSON","_propertiesToJSON","_parseTilesets","defaultAttr","spacing","margin","chips","firstgid","t","mapChip","r","tilecount","chip","columns","Math","floor","_parseLayers","_checkImage","that","imageSource","loadImage","transR","transG","transB","assets","loader","AssetLoader","load","on","elm","undefined","g","b","filter","pixel","bitmap","k","childNodes","p","tagName","getAttribute","value","textContent","parseInt","parseFloat","attributes","val","isNaN","_attrToJSON_str","each","Array","prototype","call","tileset","props","trans","d","encoding","l","_parseCSV","_parseBase64","alpha","color","draworder","nodeType","id","nodeName","pl","points","split","str","pts","imageElm","dataList","num","atob","trim","rst","charCodeAt","n","assetLoadFunctions","tmx","key","TiledMap","OVERLAY_ID","OldModule","module","bundle","Module","moduleName","hot","hotData","_acceptCallbacks","_disposeCallbacks","accept","fn","dispose","checkedAssets","assetsToAccept","parent","isParcelRequire","WebSocket","hostname","location","protocol","ws","onmessage","event","JSON","parse","handled","isNew","didAccept","hmrAcceptCheck","global","parcelRequire","every","js","clear","hmrApply","v","hmrAcceptRun","window","reload","close","onclose","removeErrorOverlay","error","message","stack","overlay","createErrorOverlay","document","body","appendChild","getElementById","remove","createElement","stackTrace","innerText","innerHTML","getParents","modules","parents","dep","isArray","Function","deps","cached","cache","some","cb"],"mappings":"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","file":"phina.tiledmap.466f95b9.js","sourceRoot":"..","sourcesContent":["/*\n *  phina.tiledmap.js\n *  2016/09/10\n *  @auther minimo  \n *  This Program is MIT license.\n *\n */\n\n/**\n * @class phina.asset.TiledMap\n * @extends phina.asset.Asset\n * # TiledMapEditorで作成したtmxファイルを読み込みクラス\n */\nphina.define(\"phina.asset.TiledMap\", {\n    superClass: \"phina.asset.Asset\",\n\n    /**\n     * @property image\n     * 作成されたマップ画像\n     */\n    image: null,\n\n    /**\n     * @property tilesets\n     * タイルセット情報\n     */\n    tilesets: null,\n\n    /**\n     * @property layers\n     * レイヤー情報が格納されている配列\n     */\n    layers: null,\n\n    init: function() {\n        this.superInit();\n    },\n\n    _load: function(resolve) {\n        //パス抜き出し\n        this.path = \"\";\n        var last = this.src.lastIndexOf(\"/\");\n        if (last > 0) {\n            this.path = this.src.substring(0, last+1);\n        }\n\n        //終了関数保存\n        this._resolve = resolve;\n\n        // load\n        var self = this;\n        var xml = new XMLHttpRequest();\n        xml.open('GET', this.src);\n        xml.onreadystatechange = function() {\n            if (xml.readyState === 4) {\n                if ([200, 201, 0].indexOf(xml.status) !== -1) {\n                    var data = xml.responseText;\n                    data = (new DOMParser()).parseFromString(data, \"text/xml\");\n                    self.dataType = \"xml\";\n                    self.data = data;\n                    self._parse(data);\n//                    resolve(self);\n                }\n            }\n        };\n        xml.send(null);\n    },\n\n    /**\n     * @method getMapData\n     * 指定したマップレイヤーを配列として取得します。\n     *\n     * @param {String} layerName 対象レイヤー名\n     */\n    getMapData: function(layerName) {\n        //レイヤー検索\n        var data = null;\n        for(var i = 0; i < this.layers.length; i++) {\n            if (this.layers[i].name == layerName) {\n                //コピーを返す\n                return this.layers[i].data.concat();\n            }\n        }\n        return null;\n    },\n\n    /**\n     * @method getObjectGroup\n     * オブジェクトグループを取得します\n     *\n     * グループ指定が無い場合、全レイヤーを配列にして返します。\n     *\n     * @param {String} grounpName 対象オブジェクトグループ名\n     */\n    getObjectGroup: function(groupName) {\n        groupName = groupName || null;\n        var ls = [];\n        var len = this.layers.length;\n        for (var i = 0; i < len; i++) {\n            if (this.layers[i].type == \"objectgroup\") {\n                if (groupName == null || groupName == this.layers[i].name) {\n                    //レイヤー情報をクローンする\n                    var obj = this._cloneObjectLayer(this.layers[i]);\n                    if (groupName !== null) return obj;\n                }\n                ls.push(obj);\n            }\n        }\n        return ls;\n    },\n\n    /**\n     * @method getMapImage\n     * マップイメージの作成\n     *\n     * 複数のマップレイヤーを指定出来ます。\n     * 描画順序はTiledMapEditor側での指定順では無く、引数の順序となります（第一引数が一番下となる）\n     *\n     * @param {String}  対象レイヤー名\n     */\n    getImage: function(...args) {\n        var numLayer = 0;\n        for (var i = 0; i < this.layers.length; i++) {\n            if (this.layers[i].type == \"layer\" || this.layers[i].type == \"imagelayer\") numLayer++;\n        }\n        if (numLayer == 0) return null;\n\n        var generated = false;\n        var width = this.width * this.tilewidth;\n        var height = this.height * this.tileheight;\n        var canvas = phina.graphics.Canvas().setSize(width, height);\n\n        for (var i = 0; i < this.layers.length; i++) {\n            var find = args.indexOf(this.layers[i].name);\n            if (args.length == 0 || find >= 0) {\n                //マップレイヤー\n                if (this.layers[i].type == \"layer\" && this.layers[i].visible != \"0\") {\n                    var layer = this.layers[i];\n                    var mapdata = layer.data;\n                    var width = layer.width;\n                    var height = layer.height;\n                    var opacity = layer.opacity || 1.0;\n                    var count = 0;\n                    for (var y = 0; y < height; y++) {\n                        for (var x = 0; x < width; x++) {\n                            var index = mapdata[count];\n                                if (index !== -1) {\n                                //マップチップを配置\n                                this._setMapChip(canvas, index, x * this.tilewidth, y * this.tileheight, opacity);\n                            }\n                            count++;\n                        }\n                    }\n                    generated = true;\n                }\n                //オブジェクトグループ\n                if (this.layers[i].type == \"objectgroup\" && this.layers[i].visible != \"0\") {\n                    var layer = this.layers[i];\n                    var opacity = layer.opacity || 1.0;\n                    layer.objects.forEach(function(e) {\n                        if (e.gid) {\n                            this._setMapChip(canvas, e.gid, e.x, e.y, opacity);\n                        }\n                    }.bind(this));\n                    generated = true;\n                }\n                //イメージレイヤー\n                if (this.layers[i].type == \"imagelayer\" && this.layers[i].visible != \"0\") {\n                    var len = this.layers[i];\n                    var image = phina.asset.AssetManager.get('image', this.layers[i].image.source);\n                    canvas.context.drawImage(image.domElement, this.layers[i].x, this.layers[i].y);\n                    generated = true;\n                }\n            }\n        }\n\n        if (!generated) return null;\n\n        var texture = phina.asset.Texture();\n        texture.domElement = canvas.domElement;\n        return texture;\n    },\n\n    /**\n     * @method _cloneObjectLayer\n     * 引数として渡されたオブジェクトレイヤーをクローンして返します。\n     *\n     * 内部で使用している関数です。\n     * @private\n     */\n    _cloneObjectLayer: function(srcLayer) {\n        var result = {}.$safe(srcLayer);\n        result.objects = [];\n        //レイヤー内オブジェクトのコピー\n        srcLayer.objects.forEach(function(obj){\n            var resObj = {\n                properties: {}.$safe(obj.properties),\n            }.$extend(obj);\n            if (obj.ellipse) resObj.ellipse = obj.ellipse;\n            if (obj.gid) resObj.gid = obj.gid;\n            if (obj.polygon) resObj.polygon = obj.polygon.clone();\n            if (obj.polyline) resObj.polyline = obj.polyline.clone();\n            result.objects.push(resObj);\n        });\n        return result;\n    },\n\n    /**\n     * @method _parse\n     * 取得したTiledMapEditのデータをパースします。\n     *\n     * 内部で使用している関数です。\n     * @private\n     */\n    _parse: function(data) {\n        //タイル属性情報取得\n        var map = data.getElementsByTagName('map')[0];\n        console.log(\"map=\"+map);\n        var attr = this._attrToJSON(map);\n        this.$extend(attr);\n        this.properties = this._propertiesToJSON(map);\n\n        //タイルセット取得\n        this.tilesets = this._parseTilesets(data);\n\n        //タイルセット情報補完\n        var defaultAttr = {\n            tilewidth: 32,\n            tileheight: 32,\n            spacing: 0,\n            margin: 0,\n        };\n        this.tilesets.chips = [];\n        for (var i = 0; i < this.tilesets.length; i++) {\n            //タイルセット属性情報取得\n            var attr = this._attrToJSON(data.getElementsByTagName('tileset')[i]);\n            attr.$safe(defaultAttr);\n            attr.firstgid--;\n            this.tilesets[i].$extend(attr);\n\n            //マップチップリスト作成\n            var t = this.tilesets[i];\n            this.tilesets[i].mapChip = [];\n            for (var r = attr.firstgid; r < attr.firstgid+attr.tilecount; r++) {\n                var chip = {\n                    image: t.image,\n                    x: ((r - attr.firstgid) % t.columns) * (t.tilewidth + t.spacing) + t.margin,\n                    y: Math.floor((r - attr.firstgid) / t.columns) * (t.tileheight + t.spacing) + t.margin,\n                }.$safe(attr);\n                this.tilesets.chips[r] = chip;\n            }\n        }\n\n        //レイヤー取得\n        this.layers = this._parseLayers(data);\n\n        //イメージデータ読み込み\n        this._checkImage();\n    },\n\n    /**\n     * @method _checkImage\n     * アセットに無いイメージデータをチェックして読み込みを行います。\n     *\n     * 内部で使用している関数です。\n     * @private\n     */\n    _checkImage: function() {\n        var that = this;\n        var imageSource = [];\n        var loadImage = [];\n\n        //一覧作成\n        for (var i = 0; i < this.tilesets.length; i++) {\n            var obj = {\n                image: this.tilesets[i].image,\n                transR: this.tilesets[i].transR,\n                transG: this.tilesets[i].transG,\n                transB: this.tilesets[i].transB,\n            };\n            imageSource.push(obj);\n        }\n        for (var i = 0; i < this.layers.length; i++) {\n            if (this.layers[i].image) {\n                var obj = {\n                    image: this.layers[i].image.source\n                };\n                imageSource.push(obj);\n            }\n        }\n\n        //アセットにあるか確認\n        for (var i = 0; i < imageSource.length; i++) {\n            var image = phina.asset.AssetManager.get('image', imageSource[i].image);\n            if (image) {\n                //アセットにある\n            } else {\n                //なかったのでロードリストに追加\n                loadImage.push(imageSource[i]);\n            }\n        }\n\n        //一括ロード\n        //ロードリスト作成\n        var assets = {\n            image: []\n        };\n        for (var i = 0; i < loadImage.length; i++) {\n            //イメージのパスをマップと同じにする\n            assets.image[loadImage[i].image] = this.path+loadImage[i].image;\n        }\n        if (loadImage.length) {\n            var loader = phina.asset.AssetLoader();\n            loader.load(assets);\n            loader.on('load', function(e) {\n                //透過色設定反映\n                loadImage.forEach(function(elm) {\n                    var image = phina.asset.AssetManager.get('image', elm.image);\n                    if (elm.transR !== undefined) {\n                        var r = elm.transR, g = elm.transG, b = elm.transB;\n                        image.filter(function(pixel, index, x, y, bitmap) {\n                            var data = bitmap.data;\n                            if (pixel[0] == r && pixel[1] == g && pixel[2] == b) {\n                                data[index+3] = 0;\n                            }\n                        });\n                    }\n                });\n                //読み込み終了\n                that._resolve(that);\n            }.bind(this));\n        } else {\n            //読み込み終了\n            this._resolve(that);\n        }\n    },\n\n    /**\n     * @method _setMapChip\n     * キャンバスの指定した座標にマップチップのイメージをコピーします。\n     *\n     * 内部で使用している関数です。\n     * @private\n     */\n    _setMapChip: function(canvas, index, x, y, opacity) {\n        //タイルセットからマップチップを取得\n        var chip = this.tilesets.chips[index];\n        if (!chip) {\n            return;\n        }\n        var image = phina.asset.AssetManager.get('image', chip.image);\n        if (!image) {\n            console.log(chip.image);\n        }\n        canvas.context.drawImage(\n            image.domElement,\n            chip.x + chip.margin, chip.y + chip.margin,\n            chip.tilewidth, chip.tileheight,\n            x, y,\n            chip.tilewidth, chip.tileheight);\n    },\n\n    /**\n     * @method _propertiesToJSON\n     * XMLプロパティをJSONに変換します。\n     *\n     * 内部で使用している関数です。\n     * @private\n     */\n    _propertiesToJSON: function(elm) {\n        var properties = elm.getElementsByTagName(\"properties\")[0];\n        var obj = {};\n        if (properties === undefined) {\n            return obj;\n        }\n        for (var k = 0; k < properties.childNodes.length; k++) {\n            var p = properties.childNodes[k];\n            if (p.tagName === \"property\") {\n                //propertyにtype指定があったら変換\n                var type = p.getAttribute('type');\n                var value = p.getAttribute('value');\n                if (!value) value = p.textContent;\n                if (type == \"int\") {\n                    obj[p.getAttribute('name')] = parseInt(value, 10);\n                } else if (type == \"float\") {\n                    obj[p.getAttribute('name')] = parseFloat(value);\n                } else if (type == \"bool\" ) {\n                    if (value == \"true\") obj[p.getAttribute('name')] = true;\n                    else obj[p.getAttribute('name')] = false;\n                } else {\n                    obj[p.getAttribute('name')] = value;\n                }\n            }\n        }\n        return obj;\n    },\n\n    /**\n     * @method _propertiesToJSON\n     * XML属性情報をJSONに変換します。\n     *\n     * 内部で使用している関数です。\n     * @private\n     */\n    _attrToJSON: function(source) {\n        console.log(\"source=\"+source);\n        var obj = {};\n        for (var i = 0; i < source.attributes.length; i++) {\n            var val = source.attributes[i].value;\n            val = isNaN(parseFloat(val))? val: parseFloat(val);\n            obj[source.attributes[i].name] = val;\n        }\n        return obj;\n    },\n\n    /**\n     * @method _propertiesToJSON_str\n     * XMLプロパティをJSONに変換し、文字列で返します。\n     *\n     * 内部で使用している関数です。\n     * @private\n     */\n    _attrToJSON_str: function(source) {\n        var obj = {};\n        for (var i = 0; i < source.attributes.length; i++) {\n            var val = source.attributes[i].value;\n            obj[source.attributes[i].name] = val;\n        }\n        return obj;\n    },\n\n    /**\n     * @method _parseTilesets\n     * タイルセットのパースを行います。\n     *\n     * 内部で使用している関数です。\n     * @private\n     */\n    _parseTilesets: function(xml) {\n        var each = Array.prototype.forEach;\n        var self = this;\n        var data = [];\n        var tilesets = xml.getElementsByTagName('tileset');\n        each.call(tilesets, function(tileset) {\n            var t = {};\n            var props = self._propertiesToJSON(tileset);\n            if (props.src) {\n                t.image = props.src;\n            } else {\n                t.image = tileset.getElementsByTagName('image')[0].getAttribute('source');\n            }\n            //透過色設定取得\n            t.trans = tileset.getElementsByTagName('image')[0].getAttribute('trans');\n            if (t.trans) {\n                t.transR = parseInt(t.trans.substring(0, 2), 16);\n                t.transG = parseInt(t.trans.substring(2, 4), 16);\n                t.transB = parseInt(t.trans.substring(4, 6), 16);\n            }\n\n            data.push(t);\n        });\n        return data;\n    },\n\n    /**\n     * @method _parseLayers\n     * レイヤー情報のパースを行います。\n     *\n     * 内部で使用している関数です。\n     * @private\n     */\n    _parseLayers: function(xml) {\n        var each = Array.prototype.forEach;\n        var data = [];\n\n        var map = xml.getElementsByTagName(\"map\")[0];\n        var layers = [];\n        each.call(map.childNodes, function(elm) {\n            if (elm.tagName == \"layer\" || elm.tagName == \"objectgroup\" || elm.tagName == \"imagelayer\") {\n                layers.push(elm);\n            }\n        });\n\n        layers.each(function(layer) {\n            switch (layer.tagName) {\n                case \"layer\":\n                    //通常レイヤー\n                    var d = layer.getElementsByTagName('data')[0];\n                    var encoding = d.getAttribute(\"encoding\");\n                    var l = {\n                        type: \"layer\",\n                        name: layer.getAttribute(\"name\"),\n                    };\n\n                    if (encoding == \"csv\") {\n                        l.data = this._parseCSV(d.textContent);\n                    } else if (encoding == \"base64\") {\n                        l.data = this._parseBase64(d.textContent);\n                    }\n\n                    var attr = this._attrToJSON(layer);\n                    l.$extend(attr);\n                    l.properties = this._propertiesToJSON(layer);\n\n                    data.push(l);\n                    break;\n\n                //オブジェクトレイヤー\n                case \"objectgroup\":\n                    var l = {\n                        type: \"objectgroup\",\n                        objects: [],\n                        name: layer.getAttribute(\"name\"),\n                        x: parseFloat(layer.getAttribute(\"offsetx\")) || 0,\n                        y: parseFloat(layer.getAttribute(\"offsety\")) || 0,\n                        alpha: layer.getAttribute(\"opacity\") || 1,\n                        color: layer.getAttribute(\"color\") || null,\n                        draworder: layer.getAttribute(\"draworder\") || null,\n                    };\n                    l.properties = this._propertiesToJSON(layer);\n\n                    //レイヤー内解析\n                    each.call(layer.childNodes, function(elm) {\n                        if (elm.nodeType == 3) return;\n                        var d = this._attrToJSON(elm);\n                        if (d.id === undefined) return;\n                        d.properties = this._propertiesToJSON(elm);\n                        //子要素の解析\n                        if (elm.childNodes.length) {\n                            elm.childNodes.forEach(function(e) {\n                                if (e.nodeType == 3) return;\n                                //楕円\n                                if (e.nodeName == 'ellipse') {\n                                    d.ellipse = true;\n                                }\n                                //多角形\n                                if (e.nodeName == 'polygon') {\n                                    d.polygon = [];\n                                    var attr = this._attrToJSON_str(e);\n                                    var pl = attr.points.split(\" \");\n                                    pl.forEach(function(str) {\n                                        var pts = str.split(\",\");\n                                        d.polygon.push({x: parseFloat(pts[0]), y: parseFloat(pts[1])});\n                                    });\n                                }\n                                //線分\n                                if (e.nodeName == 'polyline') {\n                                    d.polyline = [];\n                                    var attr = this._attrToJSON_str(e);\n                                    var pl = attr.points.split(\" \");\n                                    pl.forEach(function(str) {\n                                        var pts = str.split(\",\");\n                                        d.polyline.push({x: parseFloat(pts[0]), y: parseFloat(pts[1])});\n                                    });\n                                }\n                            }.bind(this));\n                        }\n                        l.objects.push(d);\n                    }.bind(this));\n\n                    data.push(l);\n                    break;\n\n                //イメージレイヤー\n                case \"imagelayer\":\n                    var l = {\n                        type: \"imagelayer\",\n                        name: layer.getAttribute(\"name\"),\n                        x: parseFloat(layer.getAttribute(\"offsetx\")) || 0,\n                        y: parseFloat(layer.getAttribute(\"offsety\")) || 0,\n                        alpha: layer.getAttribute(\"opacity\") || 1,\n                        visible: (layer.getAttribute(\"visible\") === undefined || layer.getAttribute(\"visible\") != 0),\n                    };\n                    var imageElm = layer.getElementsByTagName(\"image\")[0];\n                    l.image = {source: imageElm.getAttribute(\"source\")};\n\n                    data.push(l);\n                    break;\n            }\n        }.bind(this));\n        return data;\n    },\n\n    /**\n     * @method _perseCSV\n     * CSVのパースを行います。\n     *\n     * 内部で使用している関数です。\n     * @private\n     */\n    _parseCSV: function(data) {\n        var dataList = data.split(',');\n        var layer = [];\n\n        dataList.each(function(elm, i) {\n            var num = parseInt(elm, 10) - 1;\n            layer.push(num);\n        });\n\n        return layer;\n    },\n\n    /**\n     * @method _perseCSV\n     * BASE64のパースを行います。\n     *\n     * 内部で使用している関数です。\n     * http://thekannon-server.appspot.com/herpity-derpity.appspot.com/pastebin.com/75Kks0WH\n     * @private\n     */\n    _parseBase64: function(data) {\n        var dataList = atob(data.trim());\n        var rst = [];\n\n        dataList = dataList.split('').map(function(e) {\n            return e.charCodeAt(0);\n        });\n\n        for (var i=0,len=dataList.length/4; i<len; ++i) {\n            var n = dataList[i*4];\n            rst[i] = parseInt(n, 10) - 1;\n        }\n\n        return rst;\n    },\n});\n\n//ローダーに追加\nphina.asset.AssetLoader.assetLoadFunctions.tmx = function(key, path) {\n    var tmx = phina.asset.TiledMap();\n    return tmx.load(path);\n};\n","var OVERLAY_ID = '__parcel__error__overlay__';\n\nvar OldModule = module.bundle.Module;\n\nfunction Module(moduleName) {\n  OldModule.call(this, moduleName);\n  this.hot = {\n    data: module.bundle.hotData,\n    _acceptCallbacks: [],\n    _disposeCallbacks: [],\n    accept: function (fn) {\n      this._acceptCallbacks.push(fn || function () {});\n    },\n    dispose: function (fn) {\n      this._disposeCallbacks.push(fn);\n    }\n  };\n\n  module.bundle.hotData = null;\n}\n\nmodule.bundle.Module = Module;\nvar checkedAssets, assetsToAccept;\n\nvar parent = module.bundle.parent;\nif ((!parent || !parent.isParcelRequire) && typeof WebSocket !== 'undefined') {\n  var hostname = process.env.HMR_HOSTNAME || location.hostname;\n  var protocol = location.protocol === 'https:' ? 'wss' : 'ws';\n  var ws = new WebSocket(protocol + '://' + hostname + ':' + process.env.HMR_PORT + '/');\n  ws.onmessage = function(event) {\n    checkedAssets = {};\n    assetsToAccept = [];\n\n    var data = JSON.parse(event.data);\n\n    if (data.type === 'update') {\n      var handled = false;\n      data.assets.forEach(function(asset) {\n        if (!asset.isNew) {\n          var didAccept = hmrAcceptCheck(global.parcelRequire, asset.id);\n          if (didAccept) {\n            handled = true;\n          }\n        }\n      });\n\n      // Enable HMR for CSS by default.\n      handled = handled || data.assets.every(function(asset) {\n        return asset.type === 'css' && asset.generated.js;\n      });\n\n      if (handled) {\n        console.clear();\n\n        data.assets.forEach(function (asset) {\n          hmrApply(global.parcelRequire, asset);\n        });\n\n        assetsToAccept.forEach(function (v) {\n          hmrAcceptRun(v[0], v[1]);\n        });\n      } else {\n        window.location.reload();\n      }\n    }\n\n    if (data.type === 'reload') {\n      ws.close();\n      ws.onclose = function () {\n        location.reload();\n      }\n    }\n\n    if (data.type === 'error-resolved') {\n      console.log('[parcel] ✨ Error resolved');\n\n      removeErrorOverlay();\n    }\n\n    if (data.type === 'error') {\n      console.error('[parcel] 🚨  ' + data.error.message + '\\n' + data.error.stack);\n\n      removeErrorOverlay();\n\n      var overlay = createErrorOverlay(data);\n      document.body.appendChild(overlay);\n    }\n  };\n}\n\nfunction removeErrorOverlay() {\n  var overlay = document.getElementById(OVERLAY_ID);\n  if (overlay) {\n    overlay.remove();\n  }\n}\n\nfunction createErrorOverlay(data) {\n  var overlay = document.createElement('div');\n  overlay.id = OVERLAY_ID;\n\n  // html encode message and stack trace\n  var message = document.createElement('div');\n  var stackTrace = document.createElement('pre');\n  message.innerText = data.error.message;\n  stackTrace.innerText = data.error.stack;\n\n  overlay.innerHTML = (\n    '<div style=\"background: black; font-size: 16px; color: white; position: fixed; height: 100%; width: 100%; top: 0px; left: 0px; padding: 30px; opacity: 0.85; font-family: Menlo, Consolas, monospace; z-index: 9999;\">' +\n      '<span style=\"background: red; padding: 2px 4px; border-radius: 2px;\">ERROR</span>' +\n      '<span style=\"top: 2px; margin-left: 5px; position: relative;\">🚨</span>' +\n      '<div style=\"font-size: 18px; font-weight: bold; margin-top: 20px;\">' + message.innerHTML + '</div>' +\n      '<pre>' + stackTrace.innerHTML + '</pre>' +\n    '</div>'\n  );\n\n  return overlay;\n\n}\n\nfunction getParents(bundle, id) {\n  var modules = bundle.modules;\n  if (!modules) {\n    return [];\n  }\n\n  var parents = [];\n  var k, d, dep;\n\n  for (k in modules) {\n    for (d in modules[k][1]) {\n      dep = modules[k][1][d];\n      if (dep === id || (Array.isArray(dep) && dep[dep.length - 1] === id)) {\n        parents.push(k);\n      }\n    }\n  }\n\n  if (bundle.parent) {\n    parents = parents.concat(getParents(bundle.parent, id));\n  }\n\n  return parents;\n}\n\nfunction hmrApply(bundle, asset) {\n  var modules = bundle.modules;\n  if (!modules) {\n    return;\n  }\n\n  if (modules[asset.id] || !bundle.parent) {\n    var fn = new Function('require', 'module', 'exports', asset.generated.js);\n    asset.isNew = !modules[asset.id];\n    modules[asset.id] = [fn, asset.deps];\n  } else if (bundle.parent) {\n    hmrApply(bundle.parent, asset);\n  }\n}\n\nfunction hmrAcceptCheck(bundle, id) {\n  var modules = bundle.modules;\n  if (!modules) {\n    return;\n  }\n\n  if (!modules[id] && bundle.parent) {\n    return hmrAcceptCheck(bundle.parent, id);\n  }\n\n  if (checkedAssets[id]) {\n    return;\n  }\n  checkedAssets[id] = true;\n\n  var cached = bundle.cache[id];\n\n  assetsToAccept.push([bundle, id]);\n\n  if (cached && cached.hot && cached.hot._acceptCallbacks.length) {\n    return true;\n  }\n\n  return getParents(global.parcelRequire, id).some(function (id) {\n    return hmrAcceptCheck(global.parcelRequire, id)\n  });\n}\n\nfunction hmrAcceptRun(bundle, id) {\n  var cached = bundle.cache[id];\n  bundle.hotData = {};\n  if (cached) {\n    cached.hot.data = bundle.hotData;\n  }\n\n  if (cached && cached.hot && cached.hot._disposeCallbacks.length) {\n    cached.hot._disposeCallbacks.forEach(function (cb) {\n      cb(bundle.hotData);\n    });\n  }\n\n  delete bundle.cache[id];\n  bundle(id);\n\n  cached = bundle.cache[id];\n  if (cached && cached.hot && cached.hot._acceptCallbacks.length) {\n    cached.hot._acceptCallbacks.forEach(function (cb) {\n      cb();\n    });\n    return true;\n  }\n}\n"]}